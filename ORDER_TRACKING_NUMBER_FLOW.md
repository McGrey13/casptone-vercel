# ğŸ“¦ Order Tracking Number Assignment Flow

## ğŸ”„ Complete Order Flow with Tracking Number

### **When Does an Order Get a Tracking Number?**

**Answer**: When the seller **assigns a rider** and **ships the order** in the **Shipping Simulation**.

---

## ğŸ“‹ Step-by-Step Flow

### **1. Customer Places Order:**
```
Customer adds products to cart
â†“
Proceeds to checkout
â†“
Completes payment (GCash/PayMaya)
â†“
Order Created:
  - Order Number: ORD-20251008-A1B2C3
  - Status: processing
  - Payment Status: paid
  - Tracking Number: âŒ NOT YET ASSIGNED
```

### **2. Seller Views Order:**
```
Seller Dashboard â†’ Orders & Inventory
â†“
Views order in "processing" status
Order Number: ORD-20251008-A1B2C3
Customer: Juan Dela Cruz
Total: â‚±1,234.56
Tracking Number: âŒ NOT YET ASSIGNED
```

### **3. Seller Packs Order:**
```
Seller clicks "Pack" button
â†“
Order Status: packing (All Packed âœ…)
Order Number: ORD-20251008-A1B2C3
Tracking Number: âŒ STILL NOT ASSIGNED
```

### **4. Seller Goes to Shipping Simulation:**
```
Shipping Simulation shows:
  - Order ORD-20251008-A1B2C3
  - Status: packing
  - âœ… All Packed
  - Ready to assign rider
  
Tracking Number: âŒ STILL NOT ASSIGNED
```

### **5. Seller Assigns Rider â†’ TRACKING NUMBER GENERATED HERE! âœ…**
```
Seller selects order in Shipping Simulation
â†“
Enters Rider Information:
  - Rider Name: Pedro Santos
  - Phone: 09181234567
  - Vehicle: Motorcycle ABC-1234
â†“
Enters Delivery Information:
  - Address: (auto-filled from customer)
  - Delivery notes
  - Estimated delivery
â†“
Clicks "Assign Rider & Ship"
â†“
SYSTEM GENERATES TRACKING NUMBER: CC20251008FDCC7A âœ…
â†“
Creates Shipping Record:
  - Tracking Number: CC20251008FDCC7A
  - Rider assigned
  - Delivery details saved
â†“
Updates Order Status: shipped
â†“
Creates Shipping History:
  - "Package picked up by rider"
  - Location: Warehouse
  - Timestamp: Now
```

### **6. Order Now Has Tracking Number:**
```
Order Number: ORD-20251008-A1B2C3
Status: shipped
Tracking Number: âœ… CC20251008FDCC7A
â†“
Customer can now:
  - View tracking number in "To Receive" tab
  - Track package using tracking number
  - See shipping history
  - View rider information
```

### **7. Package in Transit:**
```
Status: shipped
Tracking: CC20251008FDCC7A
Location updates added to shipping history:
  - "Package in transit" @ Hub - Laguna
  - "Out for delivery" @ Cabuyao City
```

### **8. Customer Receives Package:**
```
Customer clicks "Order Received" button
â†“
Order Status: delivered
Shipping Status: delivered
â†“
Shipping History Updated:
  - "Package successfully delivered and confirmed by customer"
  - Location: Customer's city
  - Timestamp: Now
â†“
Order moved to "Completed" tab
Tracking Number: âœ… CC20251008FDCC7A (still visible)
```

---

## ğŸ¯ Summary: When Tracking Number is Assigned

| Order Stage | Status | Has Tracking? | Why? |
|-------------|--------|---------------|------|
| **Just Created** | processing | âŒ NO | Order just created, not packed yet |
| **Seller Packed** | packing | âŒ NO | Packed but no rider assigned yet |
| **Rider Assigned** | shipped | âœ… **YES** | **Tracking generated when rider assigned!** |
| **In Transit** | shipped | âœ… YES | Already has tracking from rider assignment |
| **Delivered** | delivered | âœ… YES | Keeps tracking for record |

---

## ğŸ“ Where Tracking Number is Generated

### **Location**: `ShippingController.php` â†’ `assignRider()` method

### **Code Flow**:
```php
// 1. Seller fills form in Shipping Simulation
// 2. Frontend calls API: POST /api/shipping/assign

// 3. Backend receives request with:
{
    order_id: 123,
    tracking_number: "CC20251008FDCC7A", // Generated by frontend
    rider_info: {...},
    delivery_info: {...},
    status: "shipped"
}

// 4. Backend creates shipping record
Shipping::create([
    'order_id' => $request->order_id,
    'tracking_number' => $request->tracking_number, // âœ… STORED HERE
    'rider_name' => $request->rider_info['rider_name'],
    // ... other fields
]);

// 5. Backend updates order status
$order->update(['status' => 'shipped']);

// 6. Backend creates shipping history
ShippingHistory::create([
    'status' => 'shipped',
    'description' => 'Rider assigned and package ready for shipping',
    'location' => 'Warehouse',
    'timestamp' => now()
]);
```

### **Frontend Code** (`ShippingSimulation.jsx`):
```javascript
const handleAssignRider = async (orderId) => {
  // Generate tracking number
  const trackingNum = generateTrackingNumber(); // âœ… GENERATED HERE
  // Format: CC{timestamp}{random}
  // Example: CC20251008FDCC7A
  
  const shippingData = {
    order_id: orderId,
    tracking_number: trackingNum,
    rider_info: riderInfo,
    delivery_info: deliveryInfo,
    status: 'shipped'
  };
  
  await api.post('/shipping/assign', shippingData);
};
```

---

## âœ… Correct Flow:

```
Order Created (processing)
â†“
Order Packed (packing)
â†“
ğŸ”¢ TRACKING NUMBER ASSIGNED (when shipped)
â†“
Package In Transit (shipped)
â†“
Package Delivered (delivered)
```

---

## ğŸ“Š Current System Status

### **Tracking Number Assignment:**
âœ… Generated in frontend when "Assign Rider & Ship" clicked
âœ… Format: `CC{YYYYMMDD}{6-char-hash}`
âœ… Stored in `shippings` table
âœ… Linked to order via `order_id`
âœ… Unique and indexed in database
âœ… Available immediately after assignment
âœ… Remains with order even after delivery

### **Where Tracking Numbers Appear:**
1. âœ… Shipping Simulation (after assignment)
2. âœ… E-Receipt & Waybill
3. âœ… Customer Orders page ("To Receive" tab)
4. âœ… Order Tracking page
5. âœ… Shipping history timeline
6. âœ… QR codes for scanning

---

## ğŸ¯ Answer to Your Question

**"When does an order get a tracking number when it's on delivered?"**

**Answer**: 
- Orders get tracking numbers **BEFORE** they are delivered
- Tracking number is assigned when status changes from `packing` â†’ `shipped`
- This happens when seller assigns a rider in **Shipping Simulation**
- The tracking number **stays with the order** even after it's delivered
- Delivered orders still have their tracking numbers for historical records

**Timeline:**
1. `processing` â†’ No tracking âŒ
2. `packing` â†’ No tracking âŒ
3. `shipped` â†’ **Tracking assigned** âœ… (happens here!)
4. `delivered` â†’ **Tracking remains** âœ… (not assigned here, already has it)

---

## ğŸ“± User Experience

### **Customer View:**
```
To Package (processing) â†’ No tracking number shown
To Ship (packing) â†’ No tracking number shown
To Receive (shipped) â†’ âœ… TRACKING NUMBER SHOWN: CC20251008FDCC7A
Completed (delivered) â†’ âœ… TRACKING NUMBER STILL SHOWN (for records)
```

### **Seller View:**
```
Orders & Inventory (processing/packing) â†’ No tracking
Shipping Simulation (packing) â†’ Generate tracking when assign rider
E-Receipts (shipped/delivered) â†’ âœ… Tracking number shown
```

---

**The tracking number is assigned when the order is SHIPPED (rider assigned), not when delivered!** ğŸ“¦âœ…

**Delivered orders already have their tracking numbers from when they were shipped.** ğŸšš
