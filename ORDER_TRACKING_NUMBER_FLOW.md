# 📦 Order Tracking Number Assignment Flow

## 🔄 Complete Order Flow with Tracking Number

### **When Does an Order Get a Tracking Number?**

**Answer**: When the seller **assigns a rider** and **ships the order** in the **Shipping Simulation**.

---

## 📋 Step-by-Step Flow

### **1. Customer Places Order:**
```
Customer adds products to cart
↓
Proceeds to checkout
↓
Completes payment (GCash/PayMaya)
↓
Order Created:
  - Order Number: ORD-20251008-A1B2C3
  - Status: processing
  - Payment Status: paid
  - Tracking Number: ❌ NOT YET ASSIGNED
```

### **2. Seller Views Order:**
```
Seller Dashboard → Orders & Inventory
↓
Views order in "processing" status
Order Number: ORD-20251008-A1B2C3
Customer: Juan Dela Cruz
Total: ₱1,234.56
Tracking Number: ❌ NOT YET ASSIGNED
```

### **3. Seller Packs Order:**
```
Seller clicks "Pack" button
↓
Order Status: packing (All Packed ✅)
Order Number: ORD-20251008-A1B2C3
Tracking Number: ❌ STILL NOT ASSIGNED
```

### **4. Seller Goes to Shipping Simulation:**
```
Shipping Simulation shows:
  - Order ORD-20251008-A1B2C3
  - Status: packing
  - ✅ All Packed
  - Ready to assign rider
  
Tracking Number: ❌ STILL NOT ASSIGNED
```

### **5. Seller Assigns Rider → TRACKING NUMBER GENERATED HERE! ✅**
```
Seller selects order in Shipping Simulation
↓
Enters Rider Information:
  - Rider Name: Pedro Santos
  - Phone: 09181234567
  - Vehicle: Motorcycle ABC-1234
↓
Enters Delivery Information:
  - Address: (auto-filled from customer)
  - Delivery notes
  - Estimated delivery
↓
Clicks "Assign Rider & Ship"
↓
SYSTEM GENERATES TRACKING NUMBER: CC20251008FDCC7A ✅
↓
Creates Shipping Record:
  - Tracking Number: CC20251008FDCC7A
  - Rider assigned
  - Delivery details saved
↓
Updates Order Status: shipped
↓
Creates Shipping History:
  - "Package picked up by rider"
  - Location: Warehouse
  - Timestamp: Now
```

### **6. Order Now Has Tracking Number:**
```
Order Number: ORD-20251008-A1B2C3
Status: shipped
Tracking Number: ✅ CC20251008FDCC7A
↓
Customer can now:
  - View tracking number in "To Receive" tab
  - Track package using tracking number
  - See shipping history
  - View rider information
```

### **7. Package in Transit:**
```
Status: shipped
Tracking: CC20251008FDCC7A
Location updates added to shipping history:
  - "Package in transit" @ Hub - Laguna
  - "Out for delivery" @ Cabuyao City
```

### **8. Customer Receives Package:**
```
Customer clicks "Order Received" button
↓
Order Status: delivered
Shipping Status: delivered
↓
Shipping History Updated:
  - "Package successfully delivered and confirmed by customer"
  - Location: Customer's city
  - Timestamp: Now
↓
Order moved to "Completed" tab
Tracking Number: ✅ CC20251008FDCC7A (still visible)
```

---

## 🎯 Summary: When Tracking Number is Assigned

| Order Stage | Status | Has Tracking? | Why? |
|-------------|--------|---------------|------|
| **Just Created** | processing | ❌ NO | Order just created, not packed yet |
| **Seller Packed** | packing | ❌ NO | Packed but no rider assigned yet |
| **Rider Assigned** | shipped | ✅ **YES** | **Tracking generated when rider assigned!** |
| **In Transit** | shipped | ✅ YES | Already has tracking from rider assignment |
| **Delivered** | delivered | ✅ YES | Keeps tracking for record |

---

## 📍 Where Tracking Number is Generated

### **Location**: `ShippingController.php` → `assignRider()` method

### **Code Flow**:
```php
// 1. Seller fills form in Shipping Simulation
// 2. Frontend calls API: POST /api/shipping/assign

// 3. Backend receives request with:
{
    order_id: 123,
    tracking_number: "CC20251008FDCC7A", // Generated by frontend
    rider_info: {...},
    delivery_info: {...},
    status: "shipped"
}

// 4. Backend creates shipping record
Shipping::create([
    'order_id' => $request->order_id,
    'tracking_number' => $request->tracking_number, // ✅ STORED HERE
    'rider_name' => $request->rider_info['rider_name'],
    // ... other fields
]);

// 5. Backend updates order status
$order->update(['status' => 'shipped']);

// 6. Backend creates shipping history
ShippingHistory::create([
    'status' => 'shipped',
    'description' => 'Rider assigned and package ready for shipping',
    'location' => 'Warehouse',
    'timestamp' => now()
]);
```

### **Frontend Code** (`ShippingSimulation.jsx`):
```javascript
const handleAssignRider = async (orderId) => {
  // Generate tracking number
  const trackingNum = generateTrackingNumber(); // ✅ GENERATED HERE
  // Format: CC{timestamp}{random}
  // Example: CC20251008FDCC7A
  
  const shippingData = {
    order_id: orderId,
    tracking_number: trackingNum,
    rider_info: riderInfo,
    delivery_info: deliveryInfo,
    status: 'shipped'
  };
  
  await api.post('/shipping/assign', shippingData);
};
```

---

## ✅ Correct Flow:

```
Order Created (processing)
↓
Order Packed (packing)
↓
🔢 TRACKING NUMBER ASSIGNED (when shipped)
↓
Package In Transit (shipped)
↓
Package Delivered (delivered)
```

---

## 📊 Current System Status

### **Tracking Number Assignment:**
✅ Generated in frontend when "Assign Rider & Ship" clicked
✅ Format: `CC{YYYYMMDD}{6-char-hash}`
✅ Stored in `shippings` table
✅ Linked to order via `order_id`
✅ Unique and indexed in database
✅ Available immediately after assignment
✅ Remains with order even after delivery

### **Where Tracking Numbers Appear:**
1. ✅ Shipping Simulation (after assignment)
2. ✅ E-Receipt & Waybill
3. ✅ Customer Orders page ("To Receive" tab)
4. ✅ Order Tracking page
5. ✅ Shipping history timeline
6. ✅ QR codes for scanning

---

## 🎯 Answer to Your Question

**"When does an order get a tracking number when it's on delivered?"**

**Answer**: 
- Orders get tracking numbers **BEFORE** they are delivered
- Tracking number is assigned when status changes from `packing` → `shipped`
- This happens when seller assigns a rider in **Shipping Simulation**
- The tracking number **stays with the order** even after it's delivered
- Delivered orders still have their tracking numbers for historical records

**Timeline:**
1. `processing` → No tracking ❌
2. `packing` → No tracking ❌
3. `shipped` → **Tracking assigned** ✅ (happens here!)
4. `delivered` → **Tracking remains** ✅ (not assigned here, already has it)

---

## 📱 User Experience

### **Customer View:**
```
To Package (processing) → No tracking number shown
To Ship (packing) → No tracking number shown
To Receive (shipped) → ✅ TRACKING NUMBER SHOWN: CC20251008FDCC7A
Completed (delivered) → ✅ TRACKING NUMBER STILL SHOWN (for records)
```

### **Seller View:**
```
Orders & Inventory (processing/packing) → No tracking
Shipping Simulation (packing) → Generate tracking when assign rider
E-Receipts (shipped/delivered) → ✅ Tracking number shown
```

---

**The tracking number is assigned when the order is SHIPPED (rider assigned), not when delivered!** 📦✅

**Delivered orders already have their tracking numbers from when they were shipped.** 🚚
